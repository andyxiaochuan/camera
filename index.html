<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>ğŸ“· Camera æƒé™æµ‹è¯•</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 2em;
            max-width: 600px;
            margin: auto;
        }

        video {
            width: 100%;
            margin-top: 1em;
            background: #000;
        }

        .status {
            margin: 1em 0;
        }

        .tip {
            color: red;
            font-weight: bold;
        }

        button {
            padding: 0.6em 1.2em;
            font-size: 16px;
            margin-top: 1em;
        }
    </style>
</head>

<body>
    <h1>ğŸ“· Camera æƒé™æµ‹è¯• Demo</h1>

    <div class="status">
        <p><strong>æ“ä½œç³»ç»Ÿï¼š</strong><span id="os">æ£€æµ‹ä¸­...</span></p>
        <p><strong>æµè§ˆå™¨ï¼š</strong><span id="browser">æ£€æµ‹ä¸­...</span></p>
        <p><strong>æ˜¯å¦æ”¯æŒæƒé™ APIï¼š</strong><span id="perm-support">æ£€æµ‹ä¸­...</span></p>
        <p><strong>æµè§ˆå™¨æƒé™çŠ¶æ€ï¼š</strong><span id="browser-perm">æ£€æµ‹ä¸­...</span></p>
        <p><strong>å®é™…æ‘„åƒå¤´è®¿é—®ï¼š</strong><span id="access-result">æ£€æµ‹ä¸­...</span></p>
    </div>

    <div class="tip" id="tip"></div>

    <video id="video" autoplay playsinline></video>
    <button onclick="startCamera()">å†æ¬¡å°è¯•è®¿é—®æ‘„åƒå¤´</button>

    <script>
        const OS = /iPhone|iPad|iPod/i.test(navigator.userAgent) ? 'iOS'
            : /Android/i.test(navigator.userAgent) ? 'Android'
                : 'Other';

        const Browser = /CriOS/i.test(navigator.userAgent) ? 'Chrome iOS'
            : /Safari/i.test(navigator.userAgent) && !/CriOS/i.test(navigator.userAgent) ? 'Safari'
                : /Chrome/i.test(navigator.userAgent) ? 'Chrome Android'
                    : /MicroMessenger/i.test(navigator.userAgent) ? 'WeChat'
                        : 'Unknown';

        const supportsPermissionAPI = !!(navigator.permissions && navigator.permissions.query);

        document.getElementById('os').innerText = OS;
        document.getElementById('browser').innerText = Browser;
        document.getElementById('perm-support').innerText = supportsPermissionAPI ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ';

        async function checkCameraStatus() {
            let browserPermission = 'unknown';
            if (supportsPermissionAPI) {
                try {
                    const result = await navigator.permissions.query({ name: 'camera' });
                    browserPermission = result.state;
                } catch {
                    browserPermission = 'æŸ¥è¯¢å¤±è´¥';
                }
            } else {
                browserPermission = 'æ— æ³•æŸ¥è¯¢';
            }
            document.getElementById('browser-perm').innerText = browserPermission;

            let accessResult = '';
            let tip = '';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('video').srcObject = stream;
                stream.getTracks().forEach(t => t.stop());
                accessResult = 'âœ… æˆåŠŸè·å–';
            } catch (err) {
                if (err.name === 'NotAllowedError') {
                    accessResult = 'âŒ è¢«æ‹’ç»';
                    if (browserPermission === 'granted') {
                        // ç³»ç»Ÿæƒé™æœªç»™
                        if (OS === 'iOS') {
                            tip = Browser.includes('Safari') ?
                                'è¯·å‰å¾€ è®¾ç½® > Safari > ç½‘ç«™æƒé™ > ç›¸æœº å¼€å¯æƒé™' :
                                'è¯·å‰å¾€ è®¾ç½® > Chrome > ç›¸æœºï¼Œå¼€å¯æƒé™';
                        } else if (OS === 'Android') {
                            tip = 'è¯·å‰å¾€ ç³»ç»Ÿè®¾ç½® > åº”ç”¨ > æƒé™ç®¡ç† ä¸­ä¸ºæµè§ˆå™¨å¼€å¯æ‘„åƒå¤´æƒé™';
                        } else {
                            tip = 'ç³»ç»Ÿå·²é™åˆ¶æ‘„åƒå¤´ï¼Œè¯·æ‰‹åŠ¨å¼€å¯æƒé™';
                        }
                    } else {
                        tip = 'è¯·åœ¨æµè§ˆå™¨å¼¹çª—ä¸­ç‚¹å‡»â€œå…è®¸â€æˆæƒæ‘„åƒå¤´';
                    }
                } else if (err.name === 'NotFoundError') {
                    accessResult = 'ğŸ“µ æ— æ‘„åƒå¤´è®¾å¤‡';
                } else {
                    accessResult = 'âš ï¸ å‘ç”Ÿé”™è¯¯ï¼š' + err.message;
                }
            }

            document.getElementById('access-result').innerText = accessResult;
            document.getElementById('tip').innerText = tip;
        }

        async function startCamera() {
            const video = document.getElementById('video');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
            } catch (err) {
                alert('æ‘„åƒå¤´è°ƒç”¨å¤±è´¥ï¼š' + err.message);
            }
        }

        // åˆå§‹åŒ–æ£€æµ‹
        checkCameraStatus();
    </script>
</body>

</html>